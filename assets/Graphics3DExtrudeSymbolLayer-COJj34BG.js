import{cp as G,cz as It,cq as Lt,cy as Mt,cA as B,a7 as Ot,az as Ut,kO as A,kN as Q,kM as xt,ns as Rt,nt as at,nu as ot,nv as Vt,nw as rt,kG as Bt,dB as K,nx as Ft,f1 as Gt,ck as P,lJ as Tt,dK as Z,dP as jt,m9 as kt,gK as Ht,ny as Wt,nz as Nt,cv as ct,mm as Jt,nA as Kt,nB as qt,nC as Zt,nD as Qt,nE as Xt,cj as U,gC as lt,gU as wt,cl as Yt,gV as X,nF as te,nG as ee,nH as ne,nI as se,m1 as ie,nJ as ae,gx as H,gy as oe,gw as ut}from"./index-DT-IIuD2.js";import{e as St}from"./earcut-D9gy186-.js";import{t as re,e as ht}from"./SnappingCandidate-DGkpYqI6.js";import{a as ce}from"./renderingInfoUtils-DxTOiNA1.js";import{h as Pt,i as le}from"./triangulationUtils-DwYosjAm.js";function ue(e,t,n,i){const s=Pt(e.rings,!!e.hasZ&&i.mode!=="on-the-ground",1,e.spatialReference),a=G(s.position.length),o=It(s.position,e.spatialReference,0,a,0,s.position,0,s.position.length/3,t,n,i),r=o!=null;return new de(s.position,a,Ct(s.polygons,s.position,a),vt(s.outlines,s.position,a),r,o)}function Le(e,t){const n=Pt(e.rings,!1,1),i=Lt(n.position,e.spatialReference,0,n.position,t,0);for(let s=2;s<n.position.length;s+=3)n.position[s]=Mt;return{position:n.position,polygons:Ct(n.polygons,n.position),outlines:vt(n.outlines,n.position),projectionSuccess:i}}function vt(e,t,n=null){return e.filter(({count:i})=>i>1).map(({index:i,count:s})=>{const a=3*i,o=3*s;return n!=null?new Et(i,s,B(t,a,o),B(n,a,o)):new Y(i,s,B(t,a,o))})}function Ct(e,t,n=null){const i=new Array;for(const{index:s,count:a,holeIndices:o,pathLengths:r}of e){if(a<=1)continue;const c=3*s,b=3*a,x=o.map(m=>m-s),f=n!=null?new he(s,a,B(t,3*s,3*a),B(n,c,b),x,r):new pe(s,a,B(t,3*s,3*a),x,r);i.push(f)}return i}let Y=class{constructor(t,n,i){this.index=t,this.count=n,this.position=i}};class Et extends Y{constructor(t,n,i,s){super(t,n,i),this.mapPositions=s}}class he extends Et{constructor(t,n,i,s,a,o){super(t,n,i,s),this.holeIndices=a,this.pathLengths=o}}class pe extends Y{constructor(t,n,i,s,a){super(t,n,i),this.holeIndices=s,this.pathLengths=a}}class de{constructor(t,n,i,s,a,o){this.position=t,this.mapPositions=n,this.polygons=i,this.outlines=s,this.projectionSuccess=a,this.sampledElevation=o}}function Oe(e,t,n){const i=(t.length>0?t[0]:e.length/3)-1,s=le(e,i,n);if(s!==2){e=e.slice();for(let a=0;a<e.length;a+=3)e[a+s]=e[a+2]}return St(e,t,3)}function Ue(e){const t=[["position",new A(e.attributeData.position,e.indices,3,!0)]],n=xt(e.indices.length);return e.attributeData.colorFeature!=null?t.push(["colorFeatureAttribute",new A([e.attributeData.colorFeature],n,1,!0)]):e.attributeData.color&&t.push(["color",new A(e.attributeData.color,n,4,!0)]),e.attributeData.uvMapSpace&&t.push(["uvMapSpace",new A(e.attributeData.uvMapSpace,e.indices,4,!0)]),e.attributeData.boundingRect&&t.push(["boundingRect",new A(e.attributeData.boundingRect,e.indices,9,!0)]),new Q(e.material,t,e.mapPositions,0,e.attributeData.olidColor)}function Re(e,t=null){const n=[["position",new A(e.attributeData.position,e.indices,3,!0)],["uv0",new A(e.attributeData.uv0,e.indices,2,!0)]];return new Q(e.material,n,e.mapPositions,0,t)}function ge(e){switch(e.type){case"extent":if(e instanceof Ot)return Ut.fromExtent(e);break;case"polygon":return e}return null}class Ve{constructor(t,n,i){this.renderData=t,this.layerViewUid=n,this.graphicUid=i,this.outGeometries=new Array}}const me=["polygon","extent"];class Be extends Rt{constructor(t,n,i,s){super(t,n,i,s,xe(n)),this.ensureDrapedStatus(!1)}async doLoad(){const t=this.symbolLayer,n=t?.material,i=this.symbolLayer.material?.color?.a,s=this.needsDrivenTransparentPass||i!=null&&i!==1,a=n?.emissive,o=!this._hasDrivenColorOrOpacity&&(i==null||i===0),r={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,ambient:ot,diffuse:ot,opacity:o?0:1,layerOpacity:this._getLayerOpacity(),drivenOpacity:s,hasSymbolColors:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:t.castShadows,emissiveStrength:a?.strength??0,emissiveSource:1,offsetTransparentBackfaces:!0,normalType:1},c=new at(r,this._context),b=new at({...r,cullFace:2},this._context);this._materials[0]=c,this._materials[1]=b,this._updateTransparentDepedentMaterialParameters()}destroy(){super.destroy(),this._materials.length=0}createGraphics3DGraphic(t){const n=t.graphic;if(!this._validateGeometry(n.geometry,me,this.symbolLayer.type))return null;const i=this._getDrivenUInt8ColorWithNaNSupport(t.renderingInfo,this._materialColor,!1);Vt(i,i);const s=this.createElevationContextForGraphic(n);return this._createAs3DShape(n,t.renderingInfo,i,s,n.uid)}layerOpacityChanged(t,n){const i=this._getLayerOpacity();this._materials[0]?.setParameters({layerOpacity:i}),this._materials[1]?.setParameters({layerOpacity:i}),this._updateTransparentDepedentMaterialParameters(),t?.forEach(s=>n(s)?.layerOpacityChanged(i,this._context.isAsync))}layerScreenSizePerspectiveChanged(){}layerElevationInfoChanged(t,n){return this.updateGraphics3DGraphicElevationInfo(t,n,rt)}slicePlaneEnabledChanged(t,n){return this._materials[0]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),this._materials[1]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),t?.forEach(i=>{const s=n(i);s?.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)}),!0}physicalBasedRenderingChanged(){const t={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0};return this._materials[0]?.setParameters(t),this._materials[1]?.setParameters(t),!0}_getExtrusionSize(t){let n;return n=t.size&&this._drivenProperties.size?ce(t.size,2)??0:this._getSymbolSize(),n/=this._context.renderCoordsHelper.unitInMeters,n}applyRendererDiff(t,n){return this._drivenPropertiesChanged(n)?0:1}async queryForSnapping(t,n,i,s){const a=this._getExtrusionSize(i)*this._context.renderCoordsHelper.unitInMeters/Bt(n),{objectId:o,target:r}=t,c=K(r);switch(c.z=(c.z??0)+a,t.type){case"edge":{const{start:b,end:x}=t,f=K(b),m=K(x);return f.z=(f.z??0)+a,m.z=(m.z??0)+a,[ht(o,c,1/0,f,m)]}case"vertex":return[re(o,c,1/0),ht(o,r,1/0,r,c)];default:return[]}}_getSymbolSize(){return this.symbolLayer.size??1}_createAs3DShape(t,n,i,s,a){const o=ge(t.geometry);if(o==null)return null;if(o.rings.length===0||!o.rings.some(C=>C.length>0))return this._logGeometryValidationWarnings(o.rings,"rings","ExtrudeSymbol3DLayer"),null;const r=ue(o,this._context.elevationProvider,this._context.renderCoordsHelper,s);this._logGeometryCreationWarnings(r,o.rings,"rings","ExtrudeSymbol3DLayer");const c=Ft(o);if(c==null)return null;const b=new Array,x=new Array,f=Gt(),m=Z(),w=P(),p=this._context.renderCoordsHelper.viewingMode===1;p||this._context.renderCoordsHelper.worldUpAtPosition(null,w),Tt(o.spatialReference,[c.x,c.y,0],m,this._context.renderCoordsHelper.spatialReference);const _=Z();jt(_,m);const g=Ht();kt(g,_);const{polygons:y,mapPositions:l,position:d}=r,h=new Map,v=this._materials[0];for(const C of y){const L=C.count;if(this._context.clippingExtent&&(Wt(C.mapPositions,f),!Nt(f,this._context.clippingExtent)))continue;const M=St(C.mapPositions,C.holeIndices,3);if(M.length===0)continue;const O=M.length,D=6*L,R=ct(D+O),W=ct(O),T=G(3*D),tt=G(3*D),et=G(3*D),nt=G(D);ye(d,l,M,C,T,et,tt,nt,R,W,this._getExtrusionSize(n),w,p),Jt(T,T,_);const st=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:a,layerViewUid:this._context.layerViewUid}),N=new Ce(T,et,Kt(tt),nt),J=pt(v,R,R.length-W.length,N,i,st),At=L,$t=L,zt=2*C.count,it=new Ee(At,$t,zt,O/3);Dt(J,it,m),h.set(J,it),b.push(J,pt(this._materials[1],W,0,N,i,st)),x.push(N.heights)}if(b.length===0)return null;const u=new qt({geometries:b,layerViewUid:this._context.layerViewUid,graphicUid:a,isElevationSource:!0});u.transformation=m;const $=Zt(this.symbolLayer,{opacity:this._getLayerOpacity()}),z=$?new Qt(this._materials[0],$,this._context.slicePlaneEnabled):null,I=new Xt(this,u,null,(C,L,M,O,D)=>be(C,L,M,O,D,x,h),s,z);return I.alignedSampledElevation=r.sampledElevation,I.needsElevationUpdates=rt(s.mode),I}get _materialColor(){return this.symbolLayer.material?.color}_updateTransparentDepedentMaterialParameters(){const t=this._materials[0];t&&t.setParameters({cullFace:t.transparent?0:2})}}function pt(e,t,n,i,s,a){const o=xt(t.length),r=[["position",new A(i.positions,t,3,!0)],["normalCompressed",new A(i.normals,t,2,!0)],["symbolColor",new A(s,o,4,!0)]];return new Q(e,r,i.elevation,0,a,n)}function ye(e,t,n,i,s,a,o,r,c,b,x,f,m){const w=n.length/3;let p=2*i.count;fe(e,t,i.index,i.count,n,0,w,s,a,o,r,c,b,p,x,f,m);let _=0,g=2*i.count;p=0;const y=i.pathLengths[0];dt(s,a,r,o,_,y,i.count,g,c,p,x),g+=4*y,p+=2*y,_+=y;for(let l=1;l<i.pathLengths.length;++l){const d=i.pathLengths[l];dt(s,a,r,o,_,d,i.count,g,c,p,x),g+=4*d,p+=2*d,_+=d}}function fe(e,t,n,i,s,a,o,r,c,b,x,f,m,w,p,_,g){oe(E,_),c??=[],b??=[],x??=[];const y=p>0?1:-1;let l=3*n,d=0,h=3*d,v=i,u=3*v;for(let I=0;I<i;++I){const C=e[l],L=e[l+1],M=e[l+2];g&&(E[0]=C,E[1]=L,E[2]=M,X(E,E)),r[h+0]=C,r[h+1]=L,r[h+2]=M;const O=t[l+0],D=t[l+1],R=t[l+2];c[h+0]=O,c[h+1]=D,c[h+2]=R,b[h+0]=-y*E[0],b[h+1]=-y*E[1],b[h+2]=-y*E[2],x[d]=0,r[u+0]=C+p*E[0],r[u+1]=L+p*E[1],r[u+2]=M+p*E[2],c[u+0]=O,c[u+1]=D,c[u+2]=R,x[v]=p,h+=3,u+=3,l+=3,d+=1,v+=1}l=3*a,h=0,u=3*w;const $=p<0?bt:_t,z=p<0?_t:bt;for(let I=0;I<o;++I)m[h]=s[l+$[0]],m[h+1]=s[l+$[1]],m[h+2]=s[l+$[2]],f[u]=s[l+z[0]]+i,f[u+1]=s[l+z[1]]+i,f[u+2]=s[l+z[2]]+i,h+=3,u+=3,l+=3}function j(e,t,n,i,s,a,o){i[a]=i[o],o*=3,e[a*=3]=e[o],e[a+1]=e[o+1],e[a+2]=e[o+2],t[a]=t[o],t[a+1]=t[o+1],t[a+2]=t[o+2],n[a]=s[0],n[a+1]=s[1],n[a+2]=s[2]}const F=P();function dt(e,t,n,i,s,a,o,r,c,b,x){t??=[],n??=[],i??=[];let f=s,m=s+1,w=s+o,p=s+o+1,_=r,g=r+1,y=r+2*a,l=r+2*a+1;x<0&&(f=s+o+1,p=s);let d=3*b;for(let h=0;h<a;++h)h===a-1&&(m=s,x>0?p=s+o:f=s+o),_e(e,f,m,w,F),j(e,t,i,n,F,_,f),j(e,t,i,n,F,g,m),j(e,t,i,n,F,y,w),j(e,t,i,n,F,l,p),c[d]=_,c[d+1]=y,c[d+2]=l,c[d+3]=_,c[d+4]=l,c[d+5]=g,d+=6,f++,m++,w++,p++,_+=2,g+=2,y+=2,l+=2}const q=P(),gt=P(),mt=P(),yt=P(),ft=P();function _e(e,t,n,i,s){t*=3,n*=3,i*=3,U(q,e[t++],e[t++],e[t++]),U(gt,e[n++],e[n++],e[n++]),U(mt,e[i++],e[i++],e[i++]),ut(yt,gt,q),ut(ft,mt,q),wt(s,ft,yt),X(s,s)}const V=P();function be(e,t,n,i,s,a,o){const r=e.stageObject,c=r.geometries,b=c.length,x=t.mode!=="absolute-height";let f=0;const m=r.transformation,w=ee(Z(),m);for(let p=0;p<b;p+=2){const _=c[p];if(!ne(_))continue;const g=_.getMutableAttribute("position").data,y=a[p/2],l=new se(_.mapPositions),d=g.length/3;let h=!1,v=0;{let u=0;for(let $=0;$<d;$++){V[0]=g[u],V[1]=g[u+1],V[2]=g[u+2],i(l,k),x&&(v+=k.sampledElevation),ae.TESTS_DISABLE_OPTIMIZATIONS?(U(S,l.array[l.offset],l.array[l.offset+1],k.z+y[u/3]),n!=null&&s.toRenderCoords(S,n,S),H(S,S,w)):(U(S,g[u],g[u+1],g[u+2]),H(S,S,m),s.setAltitude(S,k.z+y[u/3]),H(S,S,w)),g[u]=S[0],g[u+1]=S[1],g[u+2]=S[2];const z=we/s.unitInMeters;(Math.abs(V[0]-g[u])>=z||Math.abs(V[1]-g[u+1])>=z||Math.abs(V[2]-g[u+2])>=z)&&(h=!0),l.offset+=3,u+=3}}if(h){const u=o.get(_);u&&Dt(_,u,m),r.geometryVertexAttributeUpdated(c[p],"normalCompressed"),_.invalidateBoundingInfo(),r.geometryVertexAttributeUpdated(c[p],"position"),c[p+1].invalidateBoundingInfo(),r.geometryVertexAttributeUpdated(c[p+1],"position")}f+=v/d}return f/b}function Dt(e,t,n){const i=e.getMutableAttribute("position"),s=e.getMutableAttribute("normalCompressed").data,a=i.data,o=e.attributes.get("position").indices,{topVertexStart:r,topVertexCount:c,topFaceStart:b,topFaceCount:x}=t,f=b+x,m=r+c,w=Se,p=Pe,_=ve,g=E,y=S;U(y,0,0,0);const l=(d,h)=>{const v=3*d;U(h,a[v+0],a[v+1],a[v+2]),H(h,h,n)};for(let d=b;d<f;++d){const h=3*d;l(o[h+0],w[0]),l(o[h+1],w[1]),l(o[h+2],w[2]),lt(p,w[1],w[0]),lt(_,w[2],w[0]),wt(g,p,_),Yt(y,y,g)}X(y,y);for(let d=r;d<m;++d){const h=y[0],v=y[1],u=y[2];te(s,d,h,v,u)}}function xe(e){return(e.material?.color?.a??0)===1}const S=P(),E=P(),k=new ie,_t=[0,2,1],bt=[0,1,2],we=.01,Se=[P(),P(),P()],Pe=P(),ve=P();class Ce{constructor(t,n,i,s){this.positions=t,this.elevation=n,this.normals=i,this.heights=s}}class Ee{constructor(t,n,i,s){this.topVertexStart=t,this.topVertexCount=n,this.topFaceStart=i,this.topFaceCount=s}}export{Be as K,ye as X,Ve as a,Re as c,ge as l,Le as p,ue as r,Ue as s,Oe as u};
